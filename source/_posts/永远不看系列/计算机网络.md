---
title: 计算机网络
date: 2023-09-06 16:30:00
categories: 永远不看系列
mermaid: true
mathjax: true
permalink: computer-network.html
---

## 物理层

RJ45 水晶头的接线方式有两种，多使用 T568B：橙白|橙、绿白|蓝、蓝白|绿、棕白|棕。传的是数字信号。

- 物理层之下的传输媒体
  - 导引性传输媒体：双绞线、光缆、同轴电缆、架空明线
  - 非导引性传输媒体：空气或真空

集线器工作在物理层。

- 通信双方的交互方式
  - 单向通信（单工）：一段单行道。电视、广播。
  - 双向交替通信（半双工）：一段有两个车道的马路，但是规定在一边的车道有车正在走时，另一边（相反方向）的车道不能有车走。对讲机。
  - 双向同时通信（全双工）：一段正常的两个车道的马路。

### 编码方式

编码的终点是码，即数字信号。

如何把比特和电压互相转换。

```
 1  1  0  0  1

‾‾‾‾‾‾______‾‾‾    # 极性不归零电平 Polar NRZL，Non-Return-to-Zero level

‾‾‾_________‾‾‾    # 极性不归零反转 Polar NRZI，Non-return-to-zero inverted，边界遇 1 跳变

-‾--‾--_--_--‾-    # 极性归零 Polar RZ，Return-to-Zero，正脉冲凸，负脉冲凹

‾_|‾_|_‾|_‾|‾_|    # 曼彻斯特编码（G.E. Thomas Convention）

‾_|_‾|_‾|_‾|‾_|    # 差分曼彻斯特编码（G.E. Thomas Convention）
```

曼彻斯特编码：中心始终跳变

- G.E. Thomas Convention：
  - 中心向下跳变，`‾_`，`1`
  - 中心向上跳变，`_‾`，`0`
  - 简记：**下为 1**
- IEEE 802.3 Convention 和上面的定义相反

差分曼彻斯特编码：中心始终跳变

- G.E. Thomas Convention：
  - 左边界无跳变，`1`
    - `_|_‾`
    - `‾|‾_`
  - 左边界有跳变，`0`
    - `_|‾_`
    - `‾|_‾`
  - 简记：**左连为 1**
- IEEE 802.3 Convention 和上面的定义相反

## 数据链路层

解决三个问题：

1. 发出去之后，哪一方接收
2. 传输何时开始，何时结束
3. 判断是否有传输错误

网卡：

- 负责把有线或无线电信号与比特流互转。工作在物理层和数据链路层。
- 与 CPU 和存储器并行通信，与局域网串行通信
- 接收并缓存 MAC 帧，帧的目标地址不是它自己时，或者不符合格式、校验失败时就丢弃
- 安装驱动到操作系统，实现以太网协议

### MAC

MAC 地址有 6 个字节。全 1 的地址是广播地址

Windows 查看网络适配器的 MAC 地址：ipconfig /all

- 前三个字节是 IEEE 的注册管理机构分配的，后三个字节是厂家自行分配的
- 第一个字节最低位：0 为单播，1 为多播

### 透明传输

帧定界符 SOH 0x01、EOT 0x10，转义字符 ESC 0x1B

如果数据长度超过了 MTU，会被分割成多个帧。

下到物理层：在 MAC 帧前面插入 7 字节的前同步码和 1 字节的帧定界符：就是 `10101010 10101010 ... 10101010 10101011`。交替的 10 用于时钟同步，最后一个字节的最后一个比特变了，告诉接收端，后面的就是 MAC 帧。不用标记帧结束，因为是曼彻斯特编码，一直在跳变，脱离原本的规律了就是帧结束了。

### 差错检测

比特差错：01 错了。误码率（BER）：平均每传送 $\mathrm{(BER)^{-1}}$ 个比特，会有一个比特出错。

传输差错：接收方没有收到某一个帧，或者收到了重复的帧，或者收到帧的顺序错了

**FCS**

帧检验序列 Frame Check Sequence，确保无比特差错

1. 提前规定冗余码有 3 位
2. 提前规定一个除数 $P$ ，比冗余码的长度多一位，如 `1100`
3. 把待传的数据 `1001 0001` 后边补上冗余码长度个 0，用除数除它
4. 不管大小，`1` 开头就商 `1`，`0` 开头就商 `0`：

```txt
        1
    --------------
1100|1001 0001 000
     1100
     ------
      101 0
```

5. 相减，相当于异或
6. 继续除，最后的余数 `100` 就是冗余码
7. 把冗余码添加到原数据的末尾

**CRC**

循环冗余检验 Cyclic Redundancy Check

接收方把收到的、经发送方添加了冗余码后的数据再用 $P$ 去除。传输没出错 -> 余数为零，反之为极大概率。

除数 $P$ 还有一种记法，叫生成多项式 $P(X)$：如 `1100` 记作：$X^3+X^2$

### 交换机

交换机工作在数据链路层，全双工。并且不使用 CSMA/CD 协议，但仍然使用以太网的帧结构。

交换表的结构：MAC 地址、端口号、有效时间、状态标志

源机器发送数据帧 → 交换机记录源 MAC 地址 → 交换机查找目标 MAC 地址 → 如果目标未知，广播数据帧 → STP 确保广播不会形成环路。

交换机分为直通交换和存储转发。直通交换不校验 FCS，直接读 6 字节的目标地址（有时包含前导码）。

### 以太网

以太网是局域网的一种实现方式，与 Wifi 的区别是后者不用网线。

- DIX Ethernet V2 和 IEEE 802.3 是以太网的协议，使用 CSMA/CD（冲突检测）
- IEEE 802.11 是 Wifi 的协议，使用 CSMA/CA（冲突避免）

局域网共享信道，为避免冲突，可采用静态划分信道（复用）或动态媒体接入控制

以太网 V2 的 MAC 头部：目标 MAC + 源 MAC + 类型 0800【IPv4】/80DD【IPv6】

- MAC 帧的格式
  - （带宽为 $\mathrm{10Mbit/s}$ 的）以太网 V2：
    $$
    6 + 6 + 2 + (46 \sim 1500) + 4 = (64 \sim 1518) 字节
    $$
    其中 $\mathrm{64Byte = \dfrac{51.2 \mu s \times 10Mbit/s}{8bit/Byte}}$，减去 18 字节的首部和尾部后，得到数据部分的最小长度 46 字节。

100BASE-T 以太网：

- 使用双绞线（T），带宽为 100Mbit/s。
- 标准是 IEEE 802.3u，半双工时使用 CSMA/CD 协议，全双工时不使用。
- 争用期为 5.12 μs，帧最小间隔 0.96 μs，是 10 Mbit/s 以太网的十分之一。

## 网络层

### IPv4 分类编址

4 个字节。

- A 类地址：0 + 7 位网络号 + 3 字节主机号，首字节 0 到 127
- B 类地址：10 + 14 位网络号 + 2 字节主机号，首字节 128 到 191
- C 类地址：110 + 21 位网络号 + 1 字节主机号，首字节 192 到 223

主机号全 1 是广播地址，全 0 是该子网。

私有地址：用于局域网（LAN）内部，不可直接在互联网上路由。

- A 类：10.0.0.0 到 10.255.255.255
- B 类：172.16.0.0 到 172.31.255.255
- C 类：192.168.0.0 到 192.168.255.255

### 无分类编址 CIDR

子网掩码：用于标记用 IP 地址前面的几位来表示网络地址。

子网掩码类似 `255.248.0.0` （`11111111 11111000 00000000 00000000`），即用前面 13 位表示网络地址，后面的位表示主机地址。记作 `IP地址/13`。

## 计算

信道长度、带宽和信噪比会影响数据在信道中传输的速率，而信号传播速度（电磁波在介质中的传播速度）不会。

信噪比越大，接收方接收到的信息失真越少。两种表示方式：

- $\dfrac{S}{N} = \dfrac{信号平均功率}{噪声平均功率} = 10^{\mathrm{dB}/10}$
- $\mathrm{dB} = 10 \lg\dfrac{S}{N}$

计算传输速率时，取奈氏准则和香农公式的结果小的。

Kibi：内存、存储容量，KiB = KB = 1024B

Kilo：网络带宽，K = 1000，国际单位制的词头

### $\mathrm{bit/s}$

- 速率
- 吞吐量：指实际速率，进量 + 出量。有多条链路时，吞吐量由瓶颈链路决定。
- 某信道的最高速率：时域上的带宽
- 有效数据（速）率：$\mathrm{\dfrac{数据长度}{发送时间+RTT}}$

### $\mathrm{Hz}$

频域上的带宽 W：信号频率范围的宽度

### 秒

- 发送时延：网卡发送数据的时间，与信道长度无关。$\mathrm{\dfrac{bit}{bit/s}} = \dfrac{数据长度}{发送速率}$
- 传播时延：电磁波在网线或空气中传播的时间。与信道长度有关。$\mathrm{\dfrac{m}{m/s} = \dfrac{信道长度}{信号传播速率}}$
- 处理时延：主机或路由器收到分组后，对分组进行处理的时间。
- 排队时延：分组在路由器输入队列和输出队列里排队的时间。
- ……->输出排队->发送->传播->输入排队->处理->输出排队……
- RTT：往返时间（Round-Trip Time）

这里忽略了在接收和发送之间的排队时间和处理时间。

{% mermaid gantt %}
title RTT（甘特图）
dateFormat s
axisFormat %S

    section RTT
    RTT :3,17s

    section A
    发送           :0,3s
    接收    :17,3s
    ……    :20,4s

    section 传播
    从A到B传播    :1,8s
    从B到A传播    :11,8s

    section B
    接收      :7,3s
    发送    :10,3s

{% endmermaid %}

### bit

时延带宽积：$\mathrm{s \times bit/s = 传播时延 \times 带宽}$

已经从发送端发出，但尚未到达接收端的比特数。又叫以比特为单位的链路长度。

### m/bit

每比特宽度：每个比特在信道中占据的长度。

$$
\begin{aligned}
&\mathrm{m/bit = \dfrac{m}{bit} = \dfrac{信道长}{比特数}} \\
&\mathrm{m/bit = \dfrac{m/s}{bit/s} = \dfrac{信道传播速率}{信道当前带宽}}
\end{aligned}
$$

### 其他

利用率：$网络利用率 = 1 - \dfrac{空闲时延}{当前时延}$

利用率越高，当前时延越大（堵车）。

### 码元

用来表示码的单个元。类比信号，码就是波形，码元就是在发送和解读波形时，可以分辨的最小单位波形。码元种类数是信号的状态数 $n = 2^x$

- 码元对应的比特数 $x = \log_2(n)$
- 当 $0 < x < 1$时，一个比特由多个码元表示

### 比特率和波特

$\mathrm{bit/s} = 2Wx = 2W\log_2(n)$

符号速率（码元每秒）也叫波特 Baud

### 奈奎斯特准则

无噪声低通信道中，保证接收方接收符号不出错时的速率上限为 2W x 码元数，W 为频域带宽 Hz，单位为波特。

### 香农公式

速率是有极限的，但要信息传输速率低于极限速率，就一定能找到某种方法实现无差错的传输。

香农—哈特莱容量定理，考虑到了信道有噪声：

$$
\begin{aligned}
信道极限速率 & = \mathrm{bit/s = Hz \times bit} \\
& = W \log_2(1 + \dfrac{S}{N}) \\
\end{aligned}
$$

### 正交振幅调制（QAM）

简单地理解就是：

$$
\begin{aligned}
调制后的信号 & = 振幅 \times 载波(相位) \\
y & = A\sin(\omega x + \phi) \\
\end{aligned}
$$

用不同的**振幅**和**相位**排列组合，来表示（承载）不同的基带信号，比只调幅/只调频/只调相的信息密度高。

使用 $x$ 个振幅和 $y$ 个相位的 QAM 时，一个码元对应的比特数是 $\log _2(xy)$ 向上取整。

### 信道复用

频分复用（FDM）：Frequency Division Multiplexing，把一个大频带划分成若干个小频带，把不同的信号分别调制到这些小频带里。

```
^频率
|
|-----------------
|C信号
|-----------------
|B信号
|-----------------
|A信号
|-----------------
|
|----------------------->时间
```

时分复用（TDM）：把时间分割成一个个 TDM 帧，每帧内分为若干个时隙，每个时隙内分别传送不同的信号。相当于 CPU 单核进程并发。每个 TDM 帧内保证每组信号都传了，就是没传也要保留留给它的空时隙。这造成信道利用率不高。

```
^频率
|
|--------------------------
|A|B|C|A|B|C| |B|C|A| |C|
|--------------------------
|     |     |     |     |
|TDM帧|TDM帧|TDM帧|TDM帧|
|------------------------------>时间
```

统计时分复用（STDM）：在每个 STDM 帧内，时隙数量小于信号种类数量。为每组信号动态分配时隙，比如 B 信号断了可以先不传它。

**有四组信号 ABCD：**

```
 ^信号
 |
 |--------------------------
D| d | d | d | d |
 |--------------------------
C|   | c | c | c |
 |--------------------------
B| b | b |   |   |
 |--------------------------
A| a |   | a | a |
 |------------------------------>时间
```

**STDM：**

```
^频率
|
|--------------------------
|a|b|d|b|c|d|a|d|c|c|d|a|
|--------------------------
|     |     |     |     |
|STDMf|STDMf|STDMf|STDMf|
|------------------------------>时间
```

波分复用（WDM）：就是光的频分复用，但是用波长表示。

码分复用（CDM）：CDMA 通过为每个用户分配一个独特的扩频码来实现信号的分离，这些扩频码之间是正交的。

- 编码：某用户的码元内积扩频码，与其他用户的叠加成混合信号。
- 解码：混合信号内积用户的扩频码，得到一个码元。

## 数据链路层

### PPP 协议

- 不采用序号和确认机制，接收方每收到一个帧就进行 CRC 校验，正确就收下，错误就丢弃。
- 组成部分：
  - 【网络层 -> 数据链路层】一个将 IP 数据报封装到串行链路的方法
  - 【物理层 <-> 数据链路层】一个链路控制协议 LCP (Link Control Protocol)。分配临时 IP 地址。
  - 【数据链路层 <-> 网络层】一套网络控制协议 NCP (Network Control Protocol)。
- 是有连接，面向字节的协议

帧格式：

| 字段名                 | 标志字段、地址字段、控制字段 | 协议字段                                                                           | 信息字段    | FCS | 标志字段 |
| ---------------------- | ---------------------------- | ---------------------------------------------------------------------------------- | ----------- | --- | -------- |
| **字段值（十六进制）** | 7E FF 03                     | 0021【IP 数据报】<br/>8021【NCP】<br/>C021【LCP】<br/>C023【PAP】<br/>C223【CHAP】 | ...         | ... | 7E       |
| **字节数（十进制）**   | 3                            | 2                                                                                  | <=MTU(1500) | 2   | 1        |

异步传输时的字节填充：

转义字符：7D

| 转义前  | 转义后                    |
| ------- | ------------------------- |
| 7E      | 7D 5E（减了 20）          |
| 7D      | 7D 5D（减了 20）          |
| 00 ~ 1F | 7D 20 ~ 7D 3F （加了 20） |

上面都是对 `0x20` 做异或，或者说对从低到高第六位取反。`0x20` 是 `0010 0000`。

同步传输时的零比特填充：

发现有五个连续 `1`，就填入一个 `0`。这样不会出现六个连续 `1`。

因为不是按字节传输的，是按比特传输的，为了规避定界符 `0x7E` 的 `0111 1110`。

### CSMA／CD 协议

载波监听多址接入/碰撞检测协议，以太网用的

- 使用曼彻斯特编码（中心始终跳变，01 为跳变方向不同），频带宽度比基带信号增加一倍。
- 多点接入：多台计算机连在一根总线上：多个人在同一个房间。
- 载波（载体）监听：每个站都不停地检测信道：在说话前和说话中听别人有没有说话。
- 碰撞检测：检测信号电压：听到了自己和其他人同时说话的声音。
- 一个站不能同时发送和接收：人不能同时（并行）听懂和说明白。半双工（双向交替通信）。
- 是无连接的协议：一群人头脑风暴。
- 碰撞的过程。
- 计算碰撞后重传的等待时间：截断二进制指数退避。用 r 乘争用期。
- 以太网
  - 以太网的信道利用率
  - 争用期规定为 $51.2 \mathrm{\mu s}$，如果在这段时间内没有检测到碰撞，后续就不会碰撞。
  - 帧间最小间隔为 $9.6 \mathrm{\mu s}$
  - 最短帧长 = 争用期 × 带宽。

#### CSMA/CD 协议工作流程

听到有别人正在说话时，自己不说话。

没人正在说话时，自己说话，说话过程中听到有别人说了就不说，等一段时间后再准备说。

```
准备发送 -> 载波监听<------
   ^           |         ^
   |           v         |
   |       监听到了 -> 准备发送
   |       没监听到 -> 发送，同时开始碰撞检测
   |                           |
等待随机时间（截二退）           |
   ^                           |
   |                           |
发送人为干扰信号                |
   ^                           |
   |                           v
停止发送<-------------------检测到了
                           没检测到就发送直到完成
```

#### 碰撞

单程端到端传播时延（从【说出口】到【被人听到】经历的时间）记为 $\tau$。为方便看，这里 $\tau = 20$。

B 在 $\tau - \delta$ 时刻向 A 发送，过程中检测到了碰撞。这里 $\delta = 5$。

这里碰撞的时刻是 $17.25$，即 $\tau - \delta / 2$。

{% mermaid gantt %}
gantt
title 碰撞（甘特图）
dateFormat s
axisFormat %S

    section 传播过程
    A发送后，从A到B传播          :0,20s
    B发送后，从B到A传播          :15,20s
    B检测到了碰撞，然后……          :20,36s
    A检测到了碰撞，然后……          :35,21s

{% endmermaid %}

A 或 B 发送之后，至多需要 $2 \tau$ 的时间，即端到端往返时延，才能检测到与对方发生了碰撞。

$2 \tau$ 叫【争用期】或【碰撞窗口】。

$2 \tau$ 规定为 $51.2 \mathrm{\mu s}$。

#### 强化碰撞

碰撞之后，除了停止发送数据，还要发送 32 比特或 48 比特的人为干扰信号，告诉所有用户已经发送了碰撞。

#### 截断二进制指数退避

计算碰撞后重传的等待时间。

```py
import random

tau = 25.6  # 单程时延
basic_backoff_time = 2 * tau  # 往返时延，基本退避时间


for retransmit_count in range(1, 17):
    print(f"第{retransmit_count}次重传")
    k = min(retransmit_count, 10)
    r = random.randint(0, 2**k - 1)
    print(f"退避时间：{r*basic_backoff_time}")
```

重传 16 次仍不成功就丢弃，并向高层报告。

### 以太网的信道利用率

帧的发送时间 $T_0$：

$$
\mathrm{s = \frac{bit}{bit/s} = } \frac{L}{C} = \frac{帧长}{数据发送速率}
$$

## 概述

世界上第一个网页：[http://info.cern.ch](http://info.cern.ch)

RFC 文档：“请求评论”（Request For Comments）的文档，公开发布的互联网建议标准，请求公众评论。最后制定互联网标准 STD。

互联网服务提供者（Internet Service Provider），可以是移动联通电信公司，也可以是非营利组织。主干 ISP：国 | 地区 ISP：省 | 本地 ISP：省以下。两个同级 ISP 交换信息时，可以通过互联网交换点（Internet eXchange Point）IXP，而不必通过上级 ISP。

计算机网络分边缘部分和核心部分。边缘部分是我们所有人直接使用的主机，如手机和电脑。核心部分是除了边缘主机之外的所有硬件设施，如交换机、路由器、网线。接入网是边缘部分向核心部分过渡的部分。

边缘部分的通信分 C/S 模式和 P2P 模式。两者的区别是学生向老师请教题目和学生之间互相讲题，在下载文件之后做不做种。

核心部分的通信：电路交换是提前联系用一辆专车运货；分组交换是把货物拆分成小的快递，再经过各种站点发送出去；报文交换是将货物作为一个整体，通过多个中转站运送。前两者的区别是一手和多手，后两者的区别是切不切片。

分组交换：

1. TCP 协议把报文分组，每组写上头部信息。（包裹大包分成小包，写上序号、寄出地和目的地等）
2. 通过路由器一级一级地转发到目的地。

{% mermaid gantt %}
title 分组交换（甘特图）
dateFormat s
axisFormat %S

section 1 号包
从 A 到 B :0, 5s
从 B 到 C :5, 5s
从 C 到 D :10, 5s

section 2 号包
从 A 到 B :5, 5s
从 B 到 C :10, 5s
从 C 到 D :15, 5s

section 3 号包
从 A 到 B :10, 5s
从 B 到 C :15, 5s
从 C 到 D :20, 5s
{% endmermaid %}

- 0-5 时间 1 号包裹从 A 站到 B 站
- 5-10 时间 1 号包裹从 B 站到 C 站、2 号包裹从 A 站到 B 站
- 10-15 时间 1 号包裹从 C 站到 D 站、2 号包裹从 B 站到 C 站、3 号包裹从 A 站到 B 站

3. 把各个包裹合并。
